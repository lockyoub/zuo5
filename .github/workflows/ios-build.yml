name: iOSåº”ç”¨æ‰“åŒ… - æœªç­¾åIPA

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      build_configuration:
        description: 'æ„å»ºé…ç½®'
        required: true
        default: 'Release'
        type: choice
        options:
        - Debug
        - Release
      export_unsigned:
        description: 'å¯¼å‡ºæœªç­¾åIPA'
        required: true
        default: true
        type: boolean

env:
  XCODE_VERSION: '15.0'
  IOS_VERSION: '17.0'
  PROJECT_NAME: 'StockTradingApp'
  SCHEME_NAME: 'StockTradingApp'
  
jobs:
  build-ios:
    name: æ„å»ºiOSåº”ç”¨
    runs-on: macos-latest
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: è®¾ç½®Xcodeç‰ˆæœ¬
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}
        
    - name: æ˜¾ç¤ºXcodeä¿¡æ¯
      run: |
        xcodebuild -version
        xcrun simctl list devicetypes
        
    - name: ç¼“å­˜Swift Package Manager
      uses: actions/cache@v3
      with:
        path: |
          ~/Library/Developer/Xcode/DerivedData
          ~/.swiftpm
        key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.swift', '**/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-
          
    - name: å®‰è£…ä¾èµ–
      run: |
        # å¦‚æœä½¿ç”¨CocoaPods
        if [ -f "Podfile" ]; then
          sudo gem install cocoapods
          pod install
        fi
        
        # å¦‚æœä½¿ç”¨Swift Package Manager
        if [ -f "Package.swift" ]; then
          swift package resolve
        fi
        
    - name: åˆ›å»ºé¡¹ç›®é…ç½®æ–‡ä»¶
      run: |
        # åˆ›å»ºInfo.plistï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        if [ ! -f "ios/Info.plist" ]; then
          cat > ios/Info.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleDevelopmentRegion</key>
            <string>zh_CN</string>
            <key>CFBundleDisplayName</key>
            <string>è‚¡ç¥¨äº¤æ˜“æ¨¡æ‹Ÿå™¨</string>
            <key>CFBundleExecutable</key>
            <string>\$(EXECUTABLE_NAME)</string>
            <key>CFBundleIdentifier</key>
            <string>com.stocktrading.app</string>
            <key>CFBundleInfoDictionaryVersion</key>
            <string>6.0</string>
            <key>CFBundleName</key>
            <string>\$(PRODUCT_NAME)</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleShortVersionString</key>
            <string>1.0.0</string>
            <key>CFBundleVersion</key>
            <string>\$(CURRENT_PROJECT_VERSION)</string>
            <key>LSRequiresIPhoneOS</key>
            <true/>
            <key>UIApplicationSceneManifest</key>
            <dict>
                <key>UIApplicationSupportsMultipleScenes</key>
                <true/>
                <key>UISceneConfigurations</key>
                <dict>
                    <key>UIWindowSceneSessionRoleApplication</key>
                    <array>
                        <dict>
                            <key>UISceneConfigurationName</key>
                            <string>Default Configuration</string>
                            <key>UISceneDelegateClassName</key>
                            <string></string>
                        </dict>
                    </array>
                </dict>
            </dict>
            <key>UIApplicationSupportsIndirectInputEvents</key>
            <true/>
            <key>UILaunchScreen</key>
            <dict/>
            <key>UIRequiredDeviceCapabilities</key>
            <array>
                <string>armv7</string>
            </array>
            <key>UISupportedInterfaceOrientations</key>
            <array>
                <string>UIInterfaceOrientationPortrait</string>
                <string>UIInterfaceOrientationLandscapeLeft</string>
                <string>UIInterfaceOrientationLandscapeRight</string>
            </array>
            <key>UISupportedInterfaceOrientations~ipad</key>
            <array>
                <string>UIInterfaceOrientationPortrait</string>
                <string>UIInterfaceOrientationPortraitUpsideDown</string>
                <string>UIInterfaceOrientationLandscapeLeft</string>
                <string>UIInterfaceOrientationLandscapeRight</string>
            </array>
            <key>NSAppTransportSecurity</key>
            <dict>
                <key>NSAllowsArbitraryLoads</key>
                <true/>
            </dict>
        </dict>
        </plist>
        EOF
        fi
        
    - name: åˆ›å»ºXcodeé¡¹ç›®æ–‡ä»¶
      run: |
        # åˆ›å»ºé¡¹ç›®ç›®å½•ç»“æ„
        mkdir -p ios/StockTradingApp.xcodeproj
        
        # åˆ›å»ºproject.pbxprojæ–‡ä»¶
        cat > ios/StockTradingApp.xcodeproj/project.pbxproj << 'EOF'
        // !$*UTF8*$!
        {
            archiveVersion = 1;
            classes = {
            };
            objectVersion = 56;
            objects = {
                /* Begin PBXBuildFile section */
                1D1D1D1D1D1D1D1D /* StockTradingApp.swift in Sources */ = {isa = PBXBuildFile; fileRef = 1D1D1D1C1D1D1D1C /* StockTradingApp.swift */; };
                1D1D1D1F1D1D1D1F /* ContentView.swift in Sources */ = {isa = PBXBuildFile; fileRef = 1D1D1D1E1D1D1D1E /* ContentView.swift */; };
                1D1D1D211D1D1D21 /* Assets.xcassets in Resources */ = {isa = PBXBuildFile; fileRef = 1D1D1D201D1D1D20 /* Assets.xcassets */; };
                /* End PBXBuildFile section */
                
                /* Begin PBXFileReference section */
                1D1D1D191D1D1D19 /* StockTradingApp.app */ = {isa = PBXFileReference; explicitFileType = wrapper.application; includeInIndex = 0; path = StockTradingApp.app; sourceTree = BUILT_PRODUCTS_DIR; };
                1D1D1D1C1D1D1D1C /* StockTradingApp.swift */ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = StockTradingApp.swift; sourceTree = "<group>"; };
                1D1D1D1E1D1D1D1E /* ContentView.swift */ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = ContentView.swift; sourceTree = "<group>"; };
                1D1D1D201D1D1D20 /* Assets.xcassets */ = {isa = PBXFileReference; lastKnownFileType = folder.assetcatalog; path = Assets.xcassets; sourceTree = "<group>"; };
                /* End PBXFileReference section */
                
                /* Begin PBXGroup section */
                1D1D1D101D1D1D10 = {
                    isa = PBXGroup;
                    children = (
                        1D1D1D1B1D1D1D1B /* StockTradingApp */,
                        1D1D1D1A1D1D1A1A /* Products */,
                    );
                    sourceTree = "<group>";
                };
                1D1D1D1A1D1D1A1A /* Products */ = {
                    isa = PBXGroup;
                    children = (
                        1D1D1D191D1D1D19 /* StockTradingApp.app */,
                    );
                    name = Products;
                    sourceTree = "<group>";
                };
                1D1D1D1B1D1D1D1B /* StockTradingApp */ = {
                    isa = PBXGroup;
                    children = (
                        1D1D1D1C1D1D1D1C /* StockTradingApp.swift */,
                        1D1D1D1E1D1D1D1E /* ContentView.swift */,
                        1D1D1D201D1D1D20 /* Assets.xcassets */,
                    );
                    path = StockTradingApp;
                    sourceTree = "<group>";
                };
                /* End PBXGroup section */
                
                /* Begin PBXNativeTarget section */
                1D1D1D181D1D1D18 /* StockTradingApp */ = {
                    isa = PBXNativeTarget;
                    buildConfigurationList = 1D1D1D271D1D1D27 /* Build configuration list for PBXNativeTarget "StockTradingApp" */;
                    buildPhases = (
                        1D1D1D151D1D1D15 /* Sources */,
                        1D1D1D161D1D1D16 /* Frameworks */,
                        1D1D1D171D1D1D17 /* Resources */,
                    );
                    buildRules = (
                    );
                    dependencies = (
                    );
                    name = StockTradingApp;
                    productName = StockTradingApp;
                    productReference = 1D1D1D191D1D1D19 /* StockTradingApp.app */;
                    productType = "com.apple.product-type.application";
                };
                /* End PBXNativeTarget section */
                
                /* Begin XCBuildConfiguration section */
                1D1D1D251D1D1D25 /* Debug */ = {
                    isa = XCBuildConfiguration;
                    buildSettings = {
                        ALWAYS_SEARCH_USER_PATHS = NO;
                        CLANG_ANALYZER_NONNULL = YES;
                        CLANG_ANALYZER_NUMBER_OBJECT_CONVERSION = YES_AGGRESSIVE;
                        CLANG_CXX_LANGUAGE_STANDARD = "gnu++20";
                        CLANG_ENABLE_MODULES = YES;
                        CLANG_ENABLE_OBJC_ARC = YES;
                        CLANG_ENABLE_OBJC_WEAK = YES;
                        CLANG_WARN_BLOCK_CAPTURE_AUTORELEASING = YES;
                        CLANG_WARN_BOOL_CONVERSION = YES;
                        CLANG_WARN_COMMA = YES;
                        CLANG_WARN_CONSTANT_CONVERSION = YES;
                        CLANG_WARN_DEPRECATED_OBJC_IMPLEMENTATIONS = YES;
                        CLANG_WARN_DIRECT_OBJC_ISA_USAGE = YES_ERROR;
                        CLANG_WARN_DOCUMENTATION_COMMENTS = YES;
                        CLANG_WARN_EMPTY_BODY = YES;
                        CLANG_WARN_ENUM_CONVERSION = YES;
                        CLANG_WARN_INFINITE_RECURSION = YES;
                        CLANG_WARN_INT_CONVERSION = YES;
                        CLANG_WARN_NON_LITERAL_NULL_CONVERSION = YES;
                        CLANG_WARN_OBJC_IMPLICIT_RETAIN_SELF = YES;
                        CLANG_WARN_OBJC_LITERAL_CONVERSION = YES;
                        CLANG_WARN_OBJC_ROOT_CLASS = YES_ERROR;
                        CLANG_WARN_QUOTED_INCLUDE_IN_FRAMEWORK_HEADER = YES;
                        CLANG_WARN_RANGE_LOOP_ANALYSIS = YES;
                        CLANG_WARN_STRICT_PROTOTYPES = YES;
                        CLANG_WARN_SUSPICIOUS_MOVE = YES;
                        CLANG_WARN_UNGUARDED_AVAILABILITY = YES_AGGRESSIVE;
                        CLANG_WARN_UNREACHABLE_CODE = YES;
                        CLANG_WARN__DUPLICATE_METHOD_MATCH = YES;
                        COPY_PHASE_STRIP = NO;
                        DEBUG_INFORMATION_FORMAT = dwarf;
                        ENABLE_STRICT_OBJC_MSGSEND = YES;
                        ENABLE_TESTABILITY = YES;
                        GCC_C_LANGUAGE_STANDARD = gnu11;
                        GCC_DYNAMIC_NO_PIC = NO;
                        GCC_NO_COMMON_BLOCKS = YES;
                        GCC_OPTIMIZATION_LEVEL = 0;
                        GCC_PREPROCESSOR_DEFINITIONS = (
                            "DEBUG=1",
                            "$(inherited)",
                        );
                        GCC_WARN_64_TO_32_BIT_CONVERSION = YES;
                        GCC_WARN_ABOUT_RETURN_TYPE = YES_ERROR;
                        GCC_WARN_UNDECLARED_SELECTOR = YES;
                        GCC_WARN_UNINITIALIZED_AUTOS = YES_AGGRESSIVE;
                        GCC_WARN_UNUSED_FUNCTION = YES;
                        GCC_WARN_UNUSED_VARIABLE = YES;
                        IPHONEOS_DEPLOYMENT_TARGET = 16.0;
                        MTL_ENABLE_DEBUG_INFO = INCLUDE_SOURCE;
                        MTL_FAST_MATH = YES;
                        ONLY_ACTIVE_ARCH = YES;
                        SDKROOT = iphoneos;
                        SWIFT_ACTIVE_COMPILATION_CONDITIONS = DEBUG;
                        SWIFT_OPTIMIZATION_LEVEL = "-Onone";
                    };
                    name = Debug;
                };
                1D1D1D261D1D1D26 /* Release */ = {
                    isa = XCBuildConfiguration;
                    buildSettings = {
                        ALWAYS_SEARCH_USER_PATHS = NO;
                        CLANG_ANALYZER_NONNULL = YES;
                        CLANG_ANALYZER_NUMBER_OBJECT_CONVERSION = YES_AGGRESSIVE;
                        CLANG_CXX_LANGUAGE_STANDARD = "gnu++20";
                        CLANG_ENABLE_MODULES = YES;
                        CLANG_ENABLE_OBJC_ARC = YES;
                        CLANG_ENABLE_OBJC_WEAK = YES;
                        CLANG_WARN_BLOCK_CAPTURE_AUTORELEASING = YES;
                        CLANG_WARN_BOOL_CONVERSION = YES;
                        CLANG_WARN_COMMA = YES;
                        CLANG_WARN_CONSTANT_CONVERSION = YES;
                        CLANG_WARN_DEPRECATED_OBJC_IMPLEMENTATIONS = YES;
                        CLANG_WARN_DIRECT_OBJC_ISA_USAGE = YES_ERROR;
                        CLANG_WARN_DOCUMENTATION_COMMENTS = YES;
                        CLANG_WARN_EMPTY_BODY = YES;
                        CLANG_WARN_ENUM_CONVERSION = YES;
                        CLANG_WARN_INFINITE_RECURSION = YES;
                        CLANG_WARN_INT_CONVERSION = YES;
                        CLANG_WARN_NON_LITERAL_NULL_CONVERSION = YES;
                        CLANG_WARN_OBJC_IMPLICIT_RETAIN_SELF = YES;
                        CLANG_WARN_OBJC_LITERAL_CONVERSION = YES;
                        CLANG_WARN_OBJC_ROOT_CLASS = YES_ERROR;
                        CLANG_WARN_QUOTED_INCLUDE_IN_FRAMEWORK_HEADER = YES;
                        CLANG_WARN_RANGE_LOOP_ANALYSIS = YES;
                        CLANG_WARN_STRICT_PROTOTYPES = YES;
                        CLANG_WARN_SUSPICIOUS_MOVE = YES;
                        CLANG_WARN_UNGUARDED_AVAILABILITY = YES_AGGRESSIVE;
                        CLANG_WARN_UNREACHABLE_CODE = YES;
                        CLANG_WARN__DUPLICATE_METHOD_MATCH = YES;
                        COPY_PHASE_STRIP = NO;
                        DEBUG_INFORMATION_FORMAT = "dwarf-with-dsym";
                        ENABLE_NS_ASSERTIONS = NO;
                        ENABLE_STRICT_OBJC_MSGSEND = YES;
                        GCC_C_LANGUAGE_STANDARD = gnu11;
                        GCC_NO_COMMON_BLOCKS = YES;
                        GCC_WARN_64_TO_32_BIT_CONVERSION = YES;
                        GCC_WARN_ABOUT_RETURN_TYPE = YES_ERROR;
                        GCC_WARN_UNDECLARED_SELECTOR = YES;
                        GCC_WARN_UNINITIALIZED_AUTOS = YES_AGGRESSIVE;
                        GCC_WARN_UNUSED_FUNCTION = YES;
                        GCC_WARN_UNUSED_VARIABLE = YES;
                        IPHONEOS_DEPLOYMENT_TARGET = 16.0;
                        MTL_ENABLE_DEBUG_INFO = NO;
                        MTL_FAST_MATH = YES;
                        SDKROOT = iphoneos;
                        SWIFT_COMPILATION_MODE = wholemodule;
                        SWIFT_OPTIMIZATION_LEVEL = "-O";
                        VALIDATE_PRODUCT = YES;
                    };
                    name = Release;
                };
                1D1D1D281D1D1D28 /* Debug */ = {
                    isa = XCBuildConfiguration;
                    buildSettings = {
                        ASSETCATALOG_COMPILER_APPICON_NAME = AppIcon;
                        ASSETCATALOG_COMPILER_GLOBAL_ACCENT_COLOR_NAME = AccentColor;
                        CODE_SIGN_STYLE = Manual;
                        CODE_SIGN_IDENTITY = "";
                        CURRENT_PROJECT_VERSION = 1;
                        DEVELOPMENT_ASSET_PATHS = "";
                        DEVELOPMENT_TEAM = "";
                        ENABLE_PREVIEWS = YES;
                        GENERATE_INFOPLIST_FILE = NO;
                        INFOPLIST_FILE = "Info.plist";
                        INFOPLIST_KEY_UIApplicationSceneManifest_Generation = YES;
                        INFOPLIST_KEY_UIApplicationSupportsIndirectInputEvents = YES;
                        INFOPLIST_KEY_UILaunchScreen_Generation = YES;
                        INFOPLIST_KEY_UISupportedInterfaceOrientations_iPad = "UIInterfaceOrientationPortrait UIInterfaceOrientationPortraitUpsideDown UIInterfaceOrientationLandscapeLeft UIInterfaceOrientationLandscapeRight";
                        INFOPLIST_KEY_UISupportedInterfaceOrientations_iPhone = "UIInterfaceOrientationPortrait UIInterfaceOrientationLandscapeLeft UIInterfaceOrientationLandscapeRight";
                        IPHONEOS_DEPLOYMENT_TARGET = 16.0;
                        LD_RUNPATH_SEARCH_PATHS = (
                            "$(inherited)",
                            "@executable_path/Frameworks",
                        );
                        MARKETING_VERSION = 1.0;
                        PRODUCT_BUNDLE_IDENTIFIER = com.stocktrading.app;
                        PRODUCT_NAME = "$(TARGET_NAME)";
                        PROVISIONING_PROFILE_SPECIFIER = "";
                        SWIFT_EMIT_LOC_STRINGS = YES;
                        SWIFT_VERSION = 5.0;
                        TARGETED_DEVICE_FAMILY = "1,2";
                    };
                    name = Debug;
                };
                1D1D1D291D1D1D29 /* Release */ = {
                    isa = XCBuildConfiguration;
                    buildSettings = {
                        ASSETCATALOG_COMPILER_APPICON_NAME = AppIcon;
                        ASSETCATALOG_COMPILER_GLOBAL_ACCENT_COLOR_NAME = AccentColor;
                        CODE_SIGN_STYLE = Manual;
                        CODE_SIGN_IDENTITY = "";
                        CURRENT_PROJECT_VERSION = 1;
                        DEVELOPMENT_ASSET_PATHS = "";
                        DEVELOPMENT_TEAM = "";
                        ENABLE_PREVIEWS = YES;
                        GENERATE_INFOPLIST_FILE = NO;
                        INFOPLIST_FILE = "Info.plist";
                        INFOPLIST_KEY_UIApplicationSceneManifest_Generation = YES;
                        INFOPLIST_KEY_UIApplicationSupportsIndirectInputEvents = YES;
                        INFOPLIST_KEY_UILaunchScreen_Generation = YES;
                        INFOPLIST_KEY_UISupportedInterfaceOrientations_iPad = "UIInterfaceOrientationPortrait UIInterfaceOrientationPortraitUpsideDown UIInterfaceOrientationLandscapeLeft UIInterfaceOrientationLandscapeRight";
                        INFOPLIST_KEY_UISupportedInterfaceOrientations_iPhone = "UIInterfaceOrientationPortrait UIInterfaceOrientationLandscapeLeft UIInterfaceOrientationLandscapeRight";
                        IPHONEOS_DEPLOYMENT_TARGET = 16.0;
                        LD_RUNPATH_SEARCH_PATHS = (
                            "$(inherited)",
                            "@executable_path/Frameworks",
                        );
                        MARKETING_VERSION = 1.0;
                        PRODUCT_BUNDLE_IDENTIFIER = com.stocktrading.app;
                        PRODUCT_NAME = "$(TARGET_NAME)";
                        PROVISIONING_PROFILE_SPECIFIER = "";
                        SWIFT_EMIT_LOC_STRINGS = YES;
                        SWIFT_VERSION = 5.0;
                        TARGETED_DEVICE_FAMILY = "1,2";
                    };
                    name = Release;
                };
                /* End XCBuildConfiguration section */
                
                /* Begin XCConfigurationList section */
                1D1D1D141D1D1D14 /* Build configuration list for PBXProject "StockTradingApp" */ = {
                    isa = XCConfigurationList;
                    buildConfigurations = (
                        1D1D1D251D1D1D25 /* Debug */,
                        1D1D1D261D1D1D26 /* Release */,
                    );
                    defaultConfigurationIsVisible = 0;
                    defaultConfigurationName = Release;
                };
                1D1D1D271D1D1D27 /* Build configuration list for PBXNativeTarget "StockTradingApp" */ = {
                    isa = XCConfigurationList;
                    buildConfigurations = (
                        1D1D1D281D1D1D28 /* Debug */,
                        1D1D1D291D1D1D29 /* Release */,
                    );
                    defaultConfigurationIsVisible = 0;
                    defaultConfigurationName = Release;
                };
                /* End XCConfigurationList section */
            };
            rootObject = 1D1D1D111D1D1D11 /* Project object */;
        }
        EOF
        
    - name: å¤åˆ¶æºä»£ç æ–‡ä»¶
      run: |
        # åˆ›å»ºæºç ç›®å½•ç»“æ„
        mkdir -p ios/StockTradingApp
        
        # å¤åˆ¶æ‰€æœ‰Swiftæ–‡ä»¶åˆ°æ­£ç¡®ä½ç½®
        find . -name "*.swift" -not -path "./.git/*" -not -path "./ios/StockTradingApp.xcodeproj/*" -exec cp {} ios/StockTradingApp/ \;
        
        # åˆ›å»ºåŸºæœ¬çš„Assets.xcassets
        mkdir -p ios/StockTradingApp/Assets.xcassets/AppIcon.appiconset
        cat > ios/StockTradingApp/Assets.xcassets/Contents.json << EOF
        {
          "info" : {
            "author" : "xcode",
            "version" : 1
          }
        }
        EOF
        
        cat > ios/StockTradingApp/Assets.xcassets/AppIcon.appiconset/Contents.json << EOF
        {
          "images" : [
            {
              "idiom" : "iphone",
              "scale" : "2x",
              "size" : "20x20"
            },
            {
              "idiom" : "iphone",
              "scale" : "3x",
              "size" : "20x20"
            },
            {
              "idiom" : "iphone",
              "scale" : "2x",
              "size" : "29x29"
            },
            {
              "idiom" : "iphone",
              "scale" : "3x",
              "size" : "29x29"
            },
            {
              "idiom" : "iphone",
              "scale" : "2x",
              "size" : "40x40"
            },
            {
              "idiom" : "iphone",
              "scale" : "3x",
              "size" : "40x40"
            },
            {
              "idiom" : "iphone",
              "scale" : "2x",
              "size" : "60x60"
            },
            {
              "idiom" : "iphone",
              "scale" : "3x",
              "size" : "60x60"
            },
            {
              "idiom" : "ipad",
              "scale" : "1x",
              "size" : "20x20"
            },
            {
              "idiom" : "ipad",
              "scale" : "2x",
              "size" : "20x20"
            },
            {
              "idiom" : "ipad",
              "scale" : "1x",
              "size" : "29x29"
            },
            {
              "idiom" : "ipad",
              "scale" : "2x",
              "size" : "29x29"
            },
            {
              "idiom" : "ipad",
              "scale" : "1x",
              "size" : "40x40"
            },
            {
              "idiom" : "ipad",
              "scale" : "2x",
              "size" : "40x40"
            },
            {
              "idiom" : "ipad",
              "scale" : "2x",
              "size" : "76x76"
            },
            {
              "idiom" : "ipad",
              "scale" : "2x",
              "size" : "83.5x83.5"
            },
            {
              "idiom" : "ios-marketing",
              "scale" : "1x",
              "size" : "1024x1024"
            }
          ],
          "info" : {
            "author" : "xcode",
            "version" : 1
          }
        }
        EOF
        
    - name: åˆ—å‡ºé¡¹ç›®æ–‡ä»¶
      run: |
        echo "=== é¡¹ç›®æ–‡ä»¶ç»“æ„ ==="
        find ios/ -type f -name "*.swift" -o -name "*.plist" -o -name "*.pbxproj" | head -20
        
    - name: æ¸…ç†å’Œæ„å»ºé¡¹ç›®
      run: |
        cd ios
        
        # æ¸…ç†ä¹‹å‰çš„æ„å»º
        xcodebuild clean \
          -project StockTradingApp.xcodeproj \
          -scheme ${{ env.SCHEME_NAME }} \
          -configuration ${{ github.event.inputs.build_configuration || 'Release' }}
          
    - name: æ„å»ºåº”ç”¨ç¨‹åº
      env:
        BUILD_CONFIGURATION: ${{ github.event.inputs.build_configuration || 'Release' }}
      run: |
        cd ios
        
        # æ„å»ºåº”ç”¨åˆ°æ¨¡æ‹Ÿå™¨
        xcodebuild build \
          -project StockTradingApp.xcodeproj \
          -scheme ${{ env.SCHEME_NAME }} \
          -configuration $BUILD_CONFIGURATION \
          -destination 'generic/platform=iOS Simulator' \
          -derivedDataPath build/ \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          ONLY_ACTIVE_ARCH=NO
          
    - name: æ„å»ºçœŸæœºç‰ˆæœ¬ï¼ˆç”¨äºIPAï¼‰
      env:
        BUILD_CONFIGURATION: ${{ github.event.inputs.build_configuration || 'Release' }}
      run: |
        cd ios
        
        # æ„å»ºçœŸæœºç‰ˆæœ¬
        xcodebuild build \
          -project StockTradingApp.xcodeproj \
          -scheme ${{ env.SCHEME_NAME }} \
          -configuration $BUILD_CONFIGURATION \
          -destination 'generic/platform=iOS' \
          -derivedDataPath build/ \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          ONLY_ACTIVE_ARCH=NO
          
    - name: åˆ›å»ºæœªç­¾åIPA
      if: ${{ github.event.inputs.export_unsigned == 'true' || github.event.inputs.export_unsigned == true }}
      run: |
        cd ios
        
        # æŸ¥æ‰¾æ„å»ºçš„åº”ç”¨ç¨‹åº
        APP_PATH=$(find build/Build/Products/${{ github.event.inputs.build_configuration || 'Release' }}-iphoneos -name "*.app" | head -1)
        
        if [ -z "$APP_PATH" ]; then
          echo "é”™è¯¯: æ‰¾ä¸åˆ°æ„å»ºçš„åº”ç”¨ç¨‹åº"
          exit 1
        fi
        
        echo "æ‰¾åˆ°åº”ç”¨ç¨‹åº: $APP_PATH"
        
        # åˆ›å»ºPayloadç›®å½•
        mkdir -p Payload
        
        # å¤åˆ¶åº”ç”¨ç¨‹åºåˆ°Payloadç›®å½•
        cp -R "$APP_PATH" Payload/
        
        # åˆ›å»ºIPAæ–‡ä»¶
        zip -r "StockTradingApp-unsigned.ipa" Payload/
        
        # éªŒè¯IPAæ–‡ä»¶
        ls -la *.ipa
        
        # æ˜¾ç¤ºåº”ç”¨ä¿¡æ¯
        echo "=== åº”ç”¨ç¨‹åºä¿¡æ¯ ==="
        /usr/libexec/PlistBuddy -c "Print :CFBundleIdentifier" "$APP_PATH/Info.plist" || echo "æ— æ³•è¯»å–Bundle ID"
        /usr/libexec/PlistBuddy -c "Print :CFBundleShortVersionString" "$APP_PATH/Info.plist" || echo "æ— æ³•è¯»å–ç‰ˆæœ¬å·"
        /usr/libexec/PlistBuddy -c "Print :CFBundleDisplayName" "$APP_PATH/Info.plist" || echo "æ— æ³•è¯»å–æ˜¾ç¤ºåç§°"
        
    - name: ä¸Šä¼ IPAæ„å»ºäº§ç‰©
      if: ${{ github.event.inputs.export_unsigned == 'true' || github.event.inputs.export_unsigned == true }}
      uses: actions/upload-artifact@v3
      with:
        name: StockTradingApp-IPA-${{ github.event.inputs.build_configuration || 'Release' }}-${{ github.run_number }}
        path: |
          ios/*.ipa
          ios/build/Build/Products/**/*.dSYM
        retention-days: 30
        
    - name: ä¸Šä¼ åº”ç”¨ç¨‹åºæ–‡ä»¶
      uses: actions/upload-artifact@v3
      with:
        name: StockTradingApp-App-${{ github.event.inputs.build_configuration || 'Release' }}-${{ github.run_number }}
        path: |
          ios/build/Build/Products/**/*.app
          ios/build/Build/Products/**/*.dSYM
        retention-days: 30
        
    - name: ç”Ÿæˆæ„å»ºæŠ¥å‘Š
      run: |
        cd ios
        
        echo "# iOSæ„å»ºæŠ¥å‘Š" > build-report.md
        echo "" >> build-report.md
        echo "## æ„å»ºä¿¡æ¯" >> build-report.md
        echo "- **æ„å»ºæ—¶é—´**: $(date)" >> build-report.md
        echo "- **æ„å»ºé…ç½®**: ${{ github.event.inputs.build_configuration || 'Release' }}" >> build-report.md
        echo "- **Xcodeç‰ˆæœ¬**: $(xcodebuild -version | head -1)" >> build-report.md
        echo "- **iOS SDKç‰ˆæœ¬**: $(xcrun --sdk iphoneos --show-sdk-version)" >> build-report.md
        echo "- **Gitæäº¤**: ${{ github.sha }}" >> build-report.md
        echo "" >> build-report.md
        
        if [ -f "StockTradingApp-unsigned.ipa" ]; then
          echo "## IPAæ–‡ä»¶ä¿¡æ¯" >> build-report.md
          echo "- **æ–‡ä»¶å**: StockTradingApp-unsigned.ipa" >> build-report.md
          echo "- **æ–‡ä»¶å¤§å°**: $(ls -lh *.ipa | awk '{print $5}')" >> build-report.md
          echo "- **åˆ›å»ºæ—¶é—´**: $(date)" >> build-report.md
          echo "" >> build-report.md
          echo "## å®‰è£…è¯´æ˜" >> build-report.md
          echo "1. ä¸‹è½½æœªç­¾åIPAæ–‡ä»¶" >> build-report.md
          echo "2. ä½¿ç”¨ç‰›è›™åŠ©æ‰‹æˆ–å…¶ä»–ç­¾åå·¥å…·è¿›è¡Œç­¾å" >> build-report.md
          echo "3. é€šè¿‡Xcodeæˆ–å…¶ä»–å·¥å…·å®‰è£…åˆ°è®¾å¤‡" >> build-report.md
          echo "" >> build-report.md
        fi
        
        echo "## ä½¿ç”¨è¯´æ˜" >> build-report.md
        echo "### Windowsç”¨æˆ·å®‰è£…æŒ‡å—" >> build-report.md
        echo "1. ä¸‹è½½æ„å»ºçš„IPAæ–‡ä»¶" >> build-report.md
        echo "2. ä½¿ç”¨ä»¥ä¸‹å·¥å…·ä¹‹ä¸€è¿›è¡Œç­¾å:" >> build-report.md
        echo "   - ç‰›è›™åŠ©æ‰‹ (æ¨è)" >> build-report.md
        echo "   - AltStore" >> build-report.md
        echo "   - Sideloadly" >> build-report.md
        echo "   - 3uTools" >> build-report.md
        echo "3. å®‰è£…ç­¾ååçš„åº”ç”¨åˆ°iOSè®¾å¤‡" >> build-report.md
        echo "" >> build-report.md
        echo "### å¼€å‘è€…è¯ä¹¦ç­¾å" >> build-report.md
        echo "å¦‚æœæ‚¨æœ‰å¼€å‘è€…è¯ä¹¦ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç­¾å:" >> build-report.md
        echo '```bash' >> build-report.md
        echo 'codesign -f -s "Your Developer Certificate" StockTradingApp-unsigned.ipa' >> build-report.md
        echo '```' >> build-report.md
        
        cat build-report.md
        
    - name: ä¸Šä¼ æ„å»ºæŠ¥å‘Š
      uses: actions/upload-artifact@v3
      with:
        name: Build-Report-${{ github.run_number }}
        path: ios/build-report.md
        retention-days: 90

  # å‘å¸ƒjobï¼ˆå½“æœ‰æ ‡ç­¾æ¨é€æ—¶ï¼‰
  release:
    name: åˆ›å»ºå‘å¸ƒç‰ˆæœ¬
    needs: build-ios
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v3
      with:
        pattern: StockTradingApp-*
        path: artifacts/
        
    - name: åˆ›å»ºå‘å¸ƒè¯´æ˜
      run: |
        echo "# è‚¡ç¥¨äº¤æ˜“æ¨¡æ‹Ÿå™¨ ${GITHUB_REF#refs/tags/}" > release-notes.md
        echo "" >> release-notes.md
        echo "## æ–°åŠŸèƒ½" >> release-notes.md
        echo "- å®Œæ•´çš„è‚¡ç¥¨äº¤æ˜“æ¨¡æ‹ŸåŠŸèƒ½" >> release-notes.md
        echo "- å®æ—¶å¸‚åœºæ•°æ®åŒæ­¥" >> release-notes.md
        echo "- é£é™©ç®¡ç†ç³»ç»Ÿ" >> release-notes.md
        echo "- æŠ•èµ„ç»„åˆç®¡ç†" >> release-notes.md
        echo "" >> release-notes.md
        echo "## å®‰è£…è¯´æ˜" >> release-notes.md
        echo "1. ä¸‹è½½æœªç­¾åIPAæ–‡ä»¶" >> release-notes.md
        echo "2. ä½¿ç”¨ç‰›è›™åŠ©æ‰‹æˆ–å…¶ä»–ç­¾åå·¥å…·è¿›è¡Œç­¾å" >> release-notes.md
        echo "3. å®‰è£…åˆ°iOSè®¾å¤‡" >> release-notes.md
        echo "" >> release-notes.md
        echo "## ç³»ç»Ÿè¦æ±‚" >> release-notes.md
        echo "- iOS 16.0æˆ–æ›´é«˜ç‰ˆæœ¬" >> release-notes.md
        echo "- iPhoneæˆ–iPadè®¾å¤‡" >> release-notes.md
        echo "" >> release-notes.md
        echo "## æŠ€æœ¯æ”¯æŒ" >> release-notes.md
        echo "å¦‚æœ‰é—®é¢˜ï¼Œè¯·æäº¤Issueæˆ–è”ç³»å¼€å‘å›¢é˜Ÿã€‚" >> release-notes.md
        
    - name: åˆ›å»ºGitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/**/*.ipa
          artifacts/**/build-report.md
        body_path: release-notes.md
        draft: false
        prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') }}
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # é€šçŸ¥job
  notify:
    name: æ„å»ºé€šçŸ¥
    needs: [build-ios]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: å‘é€æ„å»ºé€šçŸ¥
      run: |
        if [ "${{ needs.build-ios.result }}" == "success" ]; then
          echo "âœ… iOSåº”ç”¨æ„å»ºæˆåŠŸï¼"
          echo "ğŸ“± æœªç­¾åIPAæ–‡ä»¶å·²ç”Ÿæˆï¼Œå¯ç”¨äºç‰›è›™ç­¾å"
          echo "ğŸ“¦ æ„å»ºäº§ç‰©å·²ä¸Šä¼ åˆ°GitHub Actions Artifacts"
        else
          echo "âŒ iOSåº”ç”¨æ„å»ºå¤±è´¥"
          echo "ğŸ” è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—ä»¥äº†è§£è¯¦ç»†é”™è¯¯ä¿¡æ¯"
        fi
        
        echo ""
        echo "ğŸ”— æ„å»ºè¯¦æƒ…: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
